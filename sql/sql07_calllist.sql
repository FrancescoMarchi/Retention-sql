-- Q7: At-Risk Call List (transparent, rule-based)
CREATE OR REPLACE VIEW retention.v_at_risk_calllist AS SELECT customer_id, gender, senior_citizen, partner, dependents, tenure_months, contract_type, payment_method, monthly_charges, charge_decile, churn_flag, (CASE WHEN contract_type='Month-to-month' THEN 2 ELSE 0 END + CASE WHEN charge_decile>=7 THEN 1 ELSE 0 END + CASE WHEN tenure_months<=12 THEN 1 ELSE 0 END + CASE WHEN lower(payment_method) LIKE '%electronic check%' THEN 1 ELSE 0 END + CASE WHEN senior_citizen AND NOT partner THEN 1 ELSE 0 END) AS risk_score, TRIM(BOTH ' |' FROM (CASE WHEN contract_type='Month-to-month' THEN 'High risk: Month-to-Month |' ELSE '' END || CASE WHEN charge_decile>=7 THEN 'High spending |' ELSE '' END || CASE WHEN tenure_months<=12 THEN 'Low tenure |' ELSE '' END || CASE WHEN lower(payment_method) LIKE '%electronic check%' THEN 'Electronic check |' ELSE '' END || CASE WHEN senior_citizen AND NOT partner THEN 'Senior & solo |' ELSE '' END)) AS risk_reason, TRIM(BOTH ' |' FROM (CASE WHEN contract_type='Month-to-month' THEN 'Offer 1-year discount |' ELSE '' END || CASE WHEN charge_decile>=7 THEN 'Loyalty credit |' ELSE '' END || CASE WHEN tenure_months<=12 THEN 'Proactive onboarding call |' ELSE '' END || CASE WHEN lower(payment_method) LIKE '%electronic check%' THEN 'Move to autopay |' ELSE '' END || CASE WHEN senior_citizen AND NOT partner THEN 'Concierge support |' ELSE '' END)) AS suggested_offer FROM retention.v_customers_features WHERE contract_type='Month-to-month' OR charge_decile>=7 OR tenure_months<=12 OR lower(payment_method) LIKE '%electronic check%';

-- BI/ops-friendly versions
CREATE OR REPLACE VIEW retention.v_at_risk_calllist_compact AS SELECT customer_id, tenure_months, monthly_charges, charge_decile, contract_type, payment_method, risk_score, risk_reason, suggested_offer FROM retention.v_at_risk_calllist;

CREATE OR REPLACE VIEW retention.v_at_risk_top200 AS SELECT * FROM retention.v_at_risk_calllist_compact ORDER BY risk_score DESC, charge_decile DESC, tenure_months ASC LIMIT 200;
